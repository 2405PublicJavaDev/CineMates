<!DOCTYPE html>
<!-- Default Layout Import-->
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/defaultLayout}"
      layout:fragment="Content">
    <head>
        <script src="https://kit.fontawesome.com/7d4169cb69.js" crossorigin="anonymous"></script>
        <!-- 태그 라이브러리 다운-->
        <!-- 소스 다운 -->
        <script src="https://unpkg.com/@yaireo/tagify"></script>
        <!-- 폴리필 (구버젼 브라우저 지원) -->
        <script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
        <link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
        <title>채팅방 개설</title>
        <!-- inline CSS 영역-->
        <style th:inline="css" type="text/css">

            .createChat-main{
                display: flex;
                flex-direction: column;
                width: 100%;
            }
            .createChat-title{
                display:flex;
                width: 100%;
            }
            .createChat-content{
                width: 100%;
                height: 800px;
                background-color: #ececec;
                display: flex;
                flex-direction: row;
                justify-content: center;
                user-select:none;
                position: relative;
            }
            .list-title{
                width: 100%;
                height: 60px;
                font-weight: 500;
                color: white;
                font-size: 25px;
                background-color:black;
                line-height: 60px;
                text-align: center;
            }

            .movie-list-container{
                width: 50%;
                height: 100%;
                background-color:white;
                overflow: scroll;
                position: relative;
            }
                                /* scroll custom */
                                .movie-list-container::-webkit-scrollbar-track
                                {
                                    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
                                    border-radius: 10px;
                                    background-color: #F5F5F5;
                                }

                                .movie-list-container::-webkit-scrollbar
                                {
                                    width: 12px;
                                    background-color: #F5F5F5;
                                }

                                .movie-list-container::-webkit-scrollbar-thumb
                                {
                                    border-radius: 10px;
                                    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);
                                    background-color: #225FAE;
                                }
                                /* scroll-custom  */

            #region-list-container{
                width: 25%;
                height: 100%;
                /*background-color: #ececec;*/
                background-color: white;
            }
            #cinema-list-container{
                width: 25%;
                height: 100%;
                /*background-color:#ececec;*/
                background-color: white;
            }

            .movie-item-content{
                display: flex;
                /*margin: 15px;*/
                position: relative;
                /*border: 3px solid #EA4E4A;*/
                padding: 15px;
                cursor: pointer;
            }
            .selectedMovie{
                border: 3px solid #EA4E4A;
                padding:12px;
                background-color:white;
            }
            .selectedMovie .movie-title{
                color: #EA4E4A;
            }
            .movie-img{
                width: 150px;
                height: 200px;
                border-radius: 20px;
                background-color:gray;
                margin-right: 20px;
            }
            .movie-img img{
                width: 150px;
                height: 200px;
            }

            .check-icon{
                opacity: 0;
                position: absolute;
                right: 10px;
                top: 10px;
                color: #EA4E4A;
                font-size: 30px
            }
            .check-icon.checked{
                opacity: 1;
            }


            /*지역선택*/
               .regionBox{
                   font-size: 20px;
                   width: 100%;
                   height: 70px;
                   line-height: 70px;
                   cursor: pointer;
                   padding-left: 20px;
                   position: relative;
               }
               .checkedRegion{
                   border: 3px solid #EA4E4A;
                   /*background-color:#ececec;*/
                   color: #EA4E4A;
                   font-weight: bold;
               }
               .region-check-icon{
                   opacity: 0;
                   position: absolute;
                   right: 20px;
                   top: -4px;
                   color: #EA4E4A;
                   font-size: 30px;
               }
               .region-check-icon.checked{
                   opacity: 1;
               }


            /* 극장선택 */
            .cinemaBox{
                font-size: 20px;
                width: 100%;
                height: 70px;
                line-height: 70px;
                cursor: pointer;
                padding-left: 20px;
                position: relative;
            }
            .checkedCinema{
                border: 3px solid #EA4E4A;
                /*background-color:#ececec;*/
                color: #EA4E4A;
                font-weight: bold;
            }
            .cinema-check-icon{
                opacity: 0;
                position: absolute;
                right: 20px;
                top: -4px;
                color: #EA4E4A;
                font-size: 30px;
            }
            .cinema-check-icon.checked{
                opacity: 1;
            }

        /*  채팅방 정보  */
            .chatRoom-info{
                font-size: 25px;
                width: 80%;
                /*margin: 0 auto;*/
            }
            .charRoom-info-nameBox{
                display: flex;
                border-bottom:2px solid gray;
                height: 50px;
                margin-bottom: 10px;
            }
            .charRoom-info-nameBox input{
                font-size: 25px;
                border: none;
                width: 93%;
                outline: none;
                padding-left: 17px;
            }
            .charRoom-info-nameBox:focus-within{
                border-bottom:2px solid black;
            }

        /*   태그 css*/
            .tagify{
                border: none;
                border-bottom: 2px solid gray;
                min-width:100%;
                font-size: 20px;
            }

            #create-room-btn{
                width: 100px;
                margin: 20px;
            }

            .movie-rating-img{
                margin-right: 10px;
                display: inline-block;
                width: 36px;
                height: 36px;
                background-size: cover;
            }
        </style>

        <!-- inline JS 영역-->
        <script th:inline="javascript" type="text/javascript">

            // 영화 리스트 선택
                // 전체 체크 해제
            function unSelectedAll(){
                let movieSelectedItem = document.querySelectorAll('.movie-item-content');
                let checkedIcon = document.querySelectorAll('.check-icon');

                movieSelectedItem.forEach((item)=>{
                    item.classList.remove("selectedMovie");
                });
                checkedIcon.forEach((item)=>{
                    item.classList.remove("checked");
                });
            }

                // onclick function 체크되면 체크박스 생성
            function selectMovie(div){
                if(div.classList.contains("selectedMovie")){
                    unSelectedAll(); // 전체 체크 해제 - 영화
                    unSelectedRegion(); // 전체 체크 해제 - 지역
                    unSelectedCinema(); // 전체 체크 해제 - 극장
                    div.classList.remove("selectedMovie");
                    div.children[2].classList.remove('checked');
                }else{
                    unSelectedAll(); // 전체 체크 해제 - 영화
                    unSelectedRegion(); // 전체 체크 해제 - 지역
                    unSelectedCinema(); // 전체 체크 해제 - 극장
                    div.classList.add("selectedMovie");
                    div.children[2].classList.add('checked');
                }
            }

            // 지역 선택
                // 전체 체크 해제 - 지역
            function unSelectedRegion(){
                let regionBoxAll = document.querySelectorAll('.regionBox');
                let regionCheckedIcon = document.querySelectorAll('.region-check-icon');

                regionBoxAll.forEach((item)=>{
                    item.classList.remove("checkedRegion");
                });
                regionCheckedIcon.forEach((item)=>{
                    item.classList.remove("checked");
                });
            }
                // onclick function 체크되면 체크박스 생성 - 지역
            function selectRegion(div){
                let movieAll = document.querySelectorAll('.movie-item-content');
                let count = 0;
                movieAll.forEach(item => {
                    if(item.classList.contains('selectedMovie')){
                        count++;
                    }
                })
                if(count <= 0){
                    alert('영화를 먼저 선택해주세요!');
                }else{
                    if(div.classList.contains("checkedRegion")){
                        unSelectedRegion(); // 전체 체크 해제 - 지역
                        unSelectedCinema(); // 전체 체크 해제 - 극장
                        div.classList.remove("checkedRegion");
                        div.children[1].classList.remove('checked');
                    }else{
                        unSelectedRegion(); // 전체 체크 해제 - 지역
                        unSelectedCinema(); // 전체 체크 해제 - 극장
                        div.classList.add("checkedRegion");
                        div.children[1].classList.add('checked');
                    }
                }

            }

            // 전체 체크 해제 - 극장
            function unSelectedCinema(){
                let cinemaBoxAll = document.querySelectorAll('.cinemaBox');
                let cinemaCheckedIcon = document.querySelectorAll('.cinema-check-icon');

                cinemaBoxAll.forEach((item)=>{
                    item.classList.remove("checkedCinema");
                });

                cinemaCheckedIcon.forEach((item)=>{
                    item.classList.remove("checked");
                });
            }

            // onclick function 체크되면 체크박스 생성 - 극장
            function selectCinema(div){
                let regionAll = document.querySelectorAll('.regionBox');
                let count = 0;
                regionAll.forEach(item => {
                    if(item.classList.contains('checkedRegion')){
                        count++;
                    }
                })
                if(count <= 0){
                    alert('지역을 먼저 선택해주세요!');
                }else {
                    if (div.classList.contains("checkedCinema")) {
                        unSelectedCinema(); // 전체 체크 해제
                        div.classList.remove("checkedCinema");
                        div.children[1].classList.remove('checked');
                    } else {
                        unSelectedCinema(); // 전체 체크 해제
                        div.classList.add("checkedCinema");
                        div.children[1].classList.add('checked');
                    }
                }
            }

            // 채팅방 정보
            function changeLengthCount(){
                let nameLength = document.querySelector('input[name=roomName]').value.length;
                if(nameLength <= 30){
                    document.querySelector('.roomName-length').innerHTML = nameLength;
                }
            }


            // 로드 후 실행
            window.addEventListener('load', ()=>{
            /////////태그 js
                const input = document.querySelector('input[name=boardTagName]');
                let tagify = new Tagify(input); // Tagify 초기화

                // 태그가 추가되면 이벤트 발생
                tagify.on('add', function() {
                    console.log(tagify.value); // 입력된 태그 정보 객체(배열)
                    console.log(tagify.value[0].value) // 태그 배열 0번째 객체의 value값 -> 입력한 태그
                })
            });

            // 지역 클릭 시 ajax 처리
            let regionClick = (div) => {
                console.log(div);
                let regions = div.children[0].innerHTML;
                console.log(regions);
                $.ajax({
                    url : "/chat/cinemaList",
                    data : {
                        "regions" : regions
                    },
                    type : "POST",
                    success : function(data){ // 서버로부터 return된 값은 직렬화된 json data로 들어옴
                        console.log('성공 : regionClick');
                        console.log("data :" + data);
                        setTimeout(function() {
                            // 값이 표시될 HTML 요소에 데이터를 출력
                            $('#cinema-list-container').replaceWith(data);
                        }, 1000);
                        console.log("replaceWith 까지 성공???")
                    },
                    error : function(){
                        console.log("서버 전송 실패");
                    },

                    beforeSend: function () {
                        let width = 0;
                        let height = 0;
                        let left = 0;
                        let top = 0;
                        width = 50; height = 50;
                        top = ( $(window).height() - height ) / 2 + $(window).scrollTop(); left = ( $(window).width() - width ) / 2 + $(window).scrollLeft();

                        if($("#div_ajax_load_image").length != 0) {
                            $("#div_ajax_load_image").css({ "top": top+"px", "left": left+"px"});
                            $("#div_ajax_load_image").show();
                            $("#div_overlay").show(); // 기존 배경 어둡게 처리
                            $("#div_overlay").fadeIn(); // 부드럽게
                            $("#div_ajax_load_image").fadeIn(); // 부드럽게
                        } else {
                            $('.createChat-content').append('<div id="div_overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:9998; background-color:rgba(0, 0, 0, 0.7); "></div>');
                            $('body').append('<div id="div_ajax_load_image" style="position:absolute; top:' + top + 'px; left:' + left + 'px; width:' + width + 'px; height:' + height + 'px; z-index:9999;  filter:alpha(opacity=50); opacity:alpha*0.5; margin:auto; padding:0; "><img src="/img/chat/loading.gif" style="width:50px; height:50px;"></div>');
                        }
                    },
                    complete: function () {
                        setTimeout(function() {
                            // 1초 뒤 로딩 이미지 숨김
                            $("#div_ajax_load_image").hide();
                            $("#div_overlay").hide();
                        }, 500);

                    }

                });
            }

            // 영화 선택하면 극장나오는 쿼리문
        //     SELECT * FROM MOVIE_TBL m
        //     JOIN SHOWTIME_TBL USING(MOVIE_NO)
        //     JOIN SCREEN_TBL USING(SCREEN_NO)
        //     JOIN CINEMA_TBL USING(CINEMA_NO)
        //     WHERE m.TITLE = '베테랑2';
        //
        //
        //     FROM movie_Tbl a
        //     JOIN SHOWTIME_TBL b ON b.movie_no = a.movie_no
        //     JOIN SCREEN_TBL c ON b.screen_no = c.screen_no
        //     JOIN CINEMA_TBL d ON c.cinema_no = d.cinema_no
        //     WHERE a.movie_no = '10000';
        //
        //
        //     SELECT DISTINCT d.cinema_name
        //     FROM movie_Tbl a
        //     JOIN SHOWTIME_TBL b ON b.movie_no = a.movie_no
        //     JOIN SCREEN_TBL c ON b.screen_no = c.screen_no
        //     JOIN CINEMA_TBL d ON c.cinema_no = d.cinema_no
        //     WHERE a.movie_no = '10000';

        </script>
    </head>
    <body>
    <div class="createChat-main">
        <div class="createChat-title">
            <div class="list-title" style="border-right:1px solid gray; width: 50%;">영화선택</div>
            <div class="list-title" style="width: 25%">지역선택</div>
            <div class="list-title" style="border-left:1px solid gray; width: 25%">극장선택</div>
        </div>
        <div class="createChat-content">
            <div class="movie-list-container">
                <div class="movie-list-content" th:each="movie : ${movieList}">
                    <!--                    moive 리스트 가져오기-->
                    <div class="movie-item-content" th:id="${movie.movieNo}" onclick="selectMovie(this)">
                        <div class="movie-img">
                            <img th:src="${movie.posterUrl}" alt="영화이미지">
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: center">
                            <div style="font-size: 24px; font-weight: bold; width: 380px; height: 60%; display: flex;">
                                <span class="movie-rating-img" th:if="${movie.rating == 'ALL'}" style="background-image: url('/img/chat/all.jpg');"></span>
                                <span class="movie-rating-img" th:if="${movie.rating == '12'}" style="background-image: url('/img/chat/12.jpg');"></span>
                                <span class="movie-rating-img" th:if="${movie.rating == '15'}" style="background-image: url('/img/chat/15.jpg');"></span>
                                <span class="movie-rating-img" th:if="${movie.rating == '19'}" style="background-image: url('/img/chat/19.jpg');"></span>
                                <span style="width: 300px" th:text="${movie.title}"></span>
                            </div>
                            <div>
                                <span>시계</span>
                                <span style="font-size: 20px" th:text="${movie.runningTime}+'분'"></span>
                            </div>
                            <div>
                                <span style="font-size: 16px" th:text="'개봉일 ' + ${#dates.format(movie.releaseDate, 'yyyy년 MM월 dd일')}"></span>
                            </div>
                        </div>
                        <div class="check-icon">
                            <i class="fa-solid fa-check"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="region-list-container">
                <div class="regionBox" onclick="selectRegion(this); regionClick(this);">
                    <span th:text="'서울'"></span>
                    <span th:text="'()'"></span>
                    <div class="region-check-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
                <div class="regionBox" onclick="selectRegion(this); regionClick(this);">
                    <span th:text="'경기/인천'"></span>
                    <span th:text="'()'"></span>
                    <div class="region-check-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
                <div class="regionBox" onclick="selectRegion(this); regionClick(this);">
                    <span th:text="'충청/대전'"></span>
                    <span th:text="'()'"></span>
                    <div class="region-check-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
                <div class="regionBox" onclick="selectRegion(this); regionClick(this);">
                    <span th:text="'전라/광주'"></span>
                    <span th:text="'()'"></span>
                    <div class="region-check-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
                <div class="regionBox" onclick="selectRegion(this); regionClick(this);">
                    <span th:text="'경북/대구'"></span>
                    <span th:text="'()'"></span>
                    <div class="region-check-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
                <div class="regionBox" onclick="selectRegion(this); regionClick(this);">
                    <span th:text="'경남/부산/울산'"></span>
                    <span th:text="'()'"></span>
                    <div class="region-check-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
                <div class="regionBox" onclick="selectRegion(this); regionClick(this);">
                    <span th:text="'강원'"></span>
                    <span th:text="'()'"></span>
                    <div class="region-check-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
                <div class="regionBox" onclick="selectRegion(this); regionClick(this);">
                    <span th:text="'제주'"></span>
                    <span th:text="'()'"></span>
                    <div class="region-check-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
            </div>


            <div id="cinema-list-container">
                <div th:each="cinema : ${cinemaListByAll}" class="cinemaBox" onclick="selectCinema(this);">
                    <span th:text="${cinema}"></span>
                    <div class="cinema-check-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
            </div>

        </div>
    </div>

        <div style="font-weight: bold; font-size: 30px; margin: 20px 0">채팅방 정보 입력</div>


        <form action="/chat/create" method="post">
            <div class="chatRoom-info">
                <div class="charRoom-info-nameBox">
                    <input type="text" name="roomName" placeholder="채팅방 이름을 입력해 주세요" maxlength="30" oninput="changeLengthCount();" required>
                    <div style="color: gray;">
                        <span class="roomName-length">0</span>
                        <span>/30</span>
                    </div>
                </div>
                <label>
                    <input type="text" name="boardTagName" placeholder="해시태그로 채팅방을 소개해보세요" required>
                </label>
            </div>
    <!--        카테고리 -> 이미 선택하고 들어옴-->
            <input type="hidden" name="roomCategory">
    <!--        영화선택-->
            <input type="hidden" name="movieNo">
    <!--        지역선택-->
            <input type="hidden" name="cinemaLocationCode">
    <!--        극장선택-->
            <input type="hidden" name="cinemaNo">

            <button class="common-primary-btn" id="create-room-btn" type="button">완료</button>

        </form>


        <!--        상세페이지-->
        <!--        날짜선택-->
        <!--        시간선택-->

    </body>
</html>