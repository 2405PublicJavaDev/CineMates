<!DOCTYPE html>
<!-- Default Layout Import-->
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/defaultLayout}"
      layout:fragment="Content">
    <head>
        <title>채팅방</title>
        <!-- inline CSS 영역-->
        <style th:inline="css" type="text/css">
            *{
                font-family: "NEXON Lv1 Gothic OTF", serif;
            }
            .chat-room-container{
                display: flex;
                justify-content: space-around;
                margin: 20px 0;
            }
            .reservation-info-background{
                width: 45%;
                height: 800px;
                position: relative;
            }
            .reservation-info-box{
                width: 88%;
                height: 700px; /* background 높이에 맞춤 */
                margin: 50px auto 0;
                border: 2px solid white;
                position: relative;
                z-index: 3;
            }
            .ticket-img{
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1;
            }
            .chat-screen{
                width: 45%;
                height: 800px;
                display: flex;
                flex-direction: column;
                border-radius: 10px;
                box-shadow: 0 5px 5px 5px rgb(162, 162, 162);
            }
            .chat-screen .user-list-container{
                width: 100%;
                height: 100px;
                display: flex;
                gap: 15px;
                padding: 10px;
            }
            .chat-screen .main-screen{
                width: 100%;
                height:580px;
                background-color: #ececec;
                overflow-y: scroll;
            }
            .chat-screen .message-input-box{
                width: 100%;
                height: 120px;
            }
            .message-input-box > textarea{
                width: 100%;
                height: 65%;
                outline: none;
                border: none;
                resize:none;
                padding: 5px;
                font-size: 16px;

            }
            .message-input-box  button{
                font-size: 16px;
                width: 45px;
                height: 35px;
                border: none;
                border-radius: 5px;
                color: white;
                background-color: #EA4E4A;
                font-weight: bold;
                margin-right: 5px;

            }

            .grid-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 2fr 0.5fr 1fr;
            }

            .grid-item {
                border: 2px solid white;
            }

            .grid-title {
                grid-column: 1 / 3;
                grid-row: 1;
            }

            .grid-movieImg {
                grid-column: 1 / 3;
                grid-row: 2;
            }

            .grid-date {
                grid-column: 1;
                grid-row: 3;
            }

            .grid-time {
                grid-column: 2;
                grid-row: 3;
            }

            .grid-region {
                grid-column: 1;
                grid-row: 4;
            }

            .grid-screen {
                grid-column: 2;
                grid-row: 4;
            }
            .grid-item-name{
                text-align: center;
                font-family: 'GmarketSansMedium', sans-serif;
                font-size: 18px;
                font-weight: bold;
                margin-top: 3px;
                color: white;
            }

            .notice-box{
                width: 100%;
                position: relative;
                margin: 10px 0;
                text-align: center;
            }
            .notice-message{
                display: inline-block;
                border-radius: 15px;
                margin: 0 auto;
                background-color: #373737;
                opacity: 0.6;
                font-weight: bold;
                padding: 10px;
                max-width: 80%;
                word-wrap: break-word;
                color: white;
            }
            .my-chat-box{
                width: 100%;
                margin: 10px 0;
                position: relative;
                display: flex;
                justify-content: end;
                align-items: end;
            }
            .my-chat-date{
                display: inline-block;
                margin-right: 5px;
            }
            .my-chat-message{
                display: inline-block;
                /*border-radius: 0% 30% 30% 30%;*/
                border-radius: 15px 0 15px 15px;
                background-color: #ff7874;
                font-weight: bold;
                padding: 10px;
                max-width: 60%;
                word-wrap: break-word;
                margin-right: 10px;
            }
            .other-chat-box{
                width: 100%;
                margin: 10px 0;
                position: relative;
                display: flex;
                justify-content: start;
                align-items: end;
            }
            .other-chat-name{
            }
            .other-chat-profile{
                width: 50px;
                height: 50px;
                border-radius: 40px;
                margin-left: 5px;
                align-self: flex-start;
            }
            .other-chat-date{
                display: inline-block;
                margin-left: 5px;
            }
            .other-chat-message{
                display: inline-block;
                border-radius: 0 15px 15px 15px;
                background-color: #8faccf;
                font-weight: bold;
                padding: 10px;
                width: 100%;
                word-wrap: break-word;
            }

        </style>

        <!-- inline JS 영역-->
        <script th:inline="javascript" type="text/javascript">

        </script>
    </head>

    <body>
        <h1 style="text-align: center; margin-top: 50px">채팅방</h1>
        <div class="chat-room-container">
            <div class="reservation-info-background">
                <img class="ticket-img" src="/img/chat/ticket.png" alt="티켓">
                <div class="reservation-info-box grid-container">
                    <div class="grid-item grid-title">
                        <div class="grid-item-name">TITLE</div>
                        <div th:text="${chatRoom.title}"></div>
                    </div>
                    <div class="grid-item grid-movieImg">
                        <div class="grid-item-name"></div>
                        <div class="posterImg" th:style="'width:50%; height:100%; background-image: url('+${chatRoom.posterUrl}+'); background-position: center; background-size: cover; border-radius:20px;'">
                        </div>
                    </div>
                    <div class="grid-item grid-date">
                        <div class="grid-item-name">DATE</div>
                        <div>
                            선택하기
                        </div>
                    </div>
                    <div class="grid-item grid-time">
                        <div class="grid-item-name">TIME</div>
                        <div></div>
                    </div>
                    <div class="grid-item grid-region">
                        <div class="grid-item-name">CINEMA</div>
                        <div th:text="${chatRoom.cinemaAddress}"></div>
                        <div th:text="${chatRoom.cinemaName}"></div>
                    </div>
                    <div class="grid-item grid-screen">
                        <div class="grid-item-name">SCREEN</div>
                        <div>
                            선택하기
                        </div>
                    </div>
                </div>
            </div>
            <div class="chat-screen">
                <div class="user-list-container">
                    <div th:each="joinList:${chatJoinList}" style="display: flex; flex-direction: column;align-items: center">
                            <th:block th:if="${joinList.filePath == null}">
                                <img alt="프로필" src="/img/default_profile.png" style="width: 60px; height: 60px; border-radius: 50%;">
                            </th:block>
                            <th:block th:if="${joinList.filePath != null}">
                                <img th:src="@{|${joinList.filePath}${joinList.fileRename}|}" alt="프로필" style="width: 60px; height: 60px; border-radius: 50%;">
                            </th:block>
                        <div th:text="${joinList.memberId}"></div>
                    </div>

                </div>
                <div class="main-screen">
                    <th:block th:each="chatMessageList : ${chatMessageList}">
                        <div th:if="${!chatMessageList.messageType.name().equals('TALK')}" class="notice-box">
                            <div class="notice-message" th:text="${chatMessageList.chatContent}"></div>
                        </div>
                        <div th:if="${chatMessageList.messageType.name().equals('TALK') and chatMessageList.memberId != session.memberId}" class="other-chat-box">
                            <div class="other-chat-profile">
                                <th:block th:if="${chatMessageList.filePath == null}">
                                    <img alt="프로필" src="/img/default_profile.png" style="width: 100%; height: 100%; border-radius: 50%;">
                                </th:block>
                                <th:block th:if="${chatMessageList.filePath != null}">
                                    <img th:src="@{|${chatMessageList.filePath}${chatMessageList.fileRename}|}" alt="프로필" style="width: 100%; height: 100%; border-radius: 50%;">
                                </th:block>
                            </div>
                            <div style="max-width: 60%; margin-left: 5px">
                                <div class="other-chat-name" th:text="${chatMessageList.memberId}"></div>
                                <div class="other-chat-message" th:text="${chatMessageList.chatContent}"></div>
                            </div>
                            <div class="other-chat-date" th:text="${#dates.setFormat(chatMessageList.chatDate,'a:hh:mm')}"></div>
                        </div>
                        <div  th:if="${chatMessageList.messageType.name().equals('TALK') and chatMessageList.memberId == session.memberId}" class="my-chat-box">
                            <div class="my-chat-date" th:text="${#dates.setFormat(chatMessageList.chatDate,'a:hh:mm')}"></div>
                            <div class="my-chat-message" th:text="${chatMessageList.chatContent}"></div>
                        </div>
                    </th:block>

                </div>

                <div class="message-input-box">
                    <textarea class="message-input" placeholder="메세지 입력"></textarea>
                    <div style="display: flex; justify-content: right;">
                        <button type="button" onclick="sendMessage();" onkeydown="if(event.key === 'Enter'){sendMessage();}">전송</button>
                    </div>
                </div>
            </div>
        </div>
        <div style="width: 100%; display: flex; justify-content: end">
            <button type="button" onclick="if(confirm('채팅방을 나가시겠습니까?')) leaveChatRoom();">나가기</button>
        </div>

        <script th:inline="javascript">
            let roomNo = /*[[${chatRoom.roomNo}]]*/; // 방번호
            let memberId = /*[[${session.memberId}]]*/; // 사용자 이름 입력받기

            const socketUrl = `ws://localhost:9000/ws/chat`;
            let socket = null;

            // 새로고침시에 재연결
            webSocketConnect();

            function webSocketConnect(){
                socket = new WebSocket(socketUrl);

                socket.onopen = function() {
                    const joinMessage = {
                        messageType: 'FIRST',
                        memberId: memberId,
                        roomNo: roomNo,
                    };

                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify(joinMessage));
                        // db에 저장
                        saveMessage(joinMessage);
                    }

                };

                socket.onmessage = function(event) {
                    const responseJson = (event.data); // 서버로부터 받은 메시지 json
                    let message = JSON.parse(responseJson);
                    console.log("onmessage : "+event.data)
                    console.log(message);
                    if(memberId !== message.memberId){
                        displayMessage(message, "other");
                    }else{
                        displayMessage(message, "my")
                    }
                }

                socket.onclose = function(event){
                    // setTimeout(function() {
                    //     webSocketConnect();  // 1초 후 다시 연결 시도
                    // }, 1000);
                }
            }

            // 메세지 전송
            function sendMessage(){
                let message = document.querySelector(".message-input").value;

                const talkMessage = {
                    messageType: 'TALK',
                    memberId: memberId,
                    roomNo: roomNo,
                    chatContent: message
                };

                if(message.trim() !== '' && socket.readyState === WebSocket.OPEN){
                    // 소켓서버 전달
                    socket.send(JSON.stringify(talkMessage));
                    // db에 저장
                    saveMessage(talkMessage);
                }

            }

            function displayMessage(message, status){
               let mainScreen = document.querySelector('.main-screen');
               let currentDate = new Date();
               let hours = currentDate.getHours();
               hours = hours - 12 >= 0 ? hours - 12 : hours;
               let minutes = currentDate.getMinutes();
               let ampm = hours >= 12 && hours < 24 ? '오후' : '오전';

               let profileInfo = checkProfile(message);

               if(message.messageType === "TALK"){
                   if(status === "my"){
                       let myChatBoxDiv = document.createElement('div');
                       myChatBoxDiv.setAttribute("class", "my-chat-box");
                       myChatBoxDiv.innerHTML = `
                <div class="my-chat-box">
                    <div class="my-chat-date">${ampm} ${hours}:${minutes}</div>
                    <div class="my-chat-message">${message.chatContent}</div>
                </div>
                `;
                       mainScreen.appendChild(myChatBoxDiv);
                   }else if(status === "other"){
                       console.log("other!!")
                       let otherChatBoxDiv = document.createElement('div');
                       otherChatBoxDiv.setAttribute("class", "other-chat-box");
                       otherChatBoxDiv.innerHTML = `
                <div class="other-chat-box">
<!--                profileIno : 함수에서 return 시킨 백틱 태그임.-->
                    <div class="other-chat-profile">
                        ${profileInfo}
                    </div>
                    <div style="max-width: 60%; margin-left: 5px">
                        <div class="other-chat-name">${message.memberId}</div>
                        <div class="other-chat-message">${message.chatContent}</div>
                    </div>
                    <div class="other-chat-date">${ampm} ${hours}:${minutes}</div>
                </div>
                `;
                       mainScreen.appendChild(otherChatBoxDiv);
                   }
               }else {

                   let noticeBoxDiv = document.createElement('div');
                   noticeBoxDiv.setAttribute("class", "notice-box");
                   noticeBoxDiv.innerHTML = `
                    <div class="notice-box">
                        <div class="notice-message">${message.memberId}${message.chatContent}</div>
                    </div>
                `;
                   mainScreen.appendChild(noticeBoxDiv);

               }


            }


            function leaveChatRoom(){
                const leaveMessage = {
                    messageType: 'LEAVE',
                    memberId: memberId,
                    roomNo: roomNo,
                };

                if (socket.readyState === WebSocket.OPEN) {
                    // 소켓서버 전달
                    socket.send(JSON.stringify(leaveMessage));
                    // db 저장
                    saveMessage(leaveMessage);
                }

                // list로 이동
                location.href= '/chat/list';
            }

            function checkProfile(message){
                let joinProfile = /*[[${chatJoinList}]]*/;
                let profileCount = 0;
                let profileInfo = null;
                let profileDiv = "";
                joinProfile.forEach(profile => {
                    if(profile.memberId === message.memberId){
                        profileCount++;
                        profileInfo = profile;
                    }
                });
                if(profileCount > 0){
                    profileDiv = `
                <img src="${profileInfo.filePath}${profileInfo.fileRename}" alt="프로필" style="width: 100%; height: 100%; border-radius: 50%;">
                `;
                }else{
                    profileDiv =
                        `
                        <img alt="프로필" src="/img/default_profile.png" style="width: 100%; height: 100%; border-radius: 50%;">
                        `;
                }

                return profileDiv;
            }


            // 메세지 저장 로직
            function saveMessage(message){
                // AJAX 요청으로 메시지 저장
                fetch('/chat/insertChat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(message) // 전송할 데이터를 JSON 형태로 변환
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('메시지 저장 중 에러 발생');
                        }
                        return response.json(); // 응답을 json 형태로 변환
                    })
                    .then(data => {
                        console.log('메시지가 DB에 저장되었습니다:', data);
                    })
                    .catch(error => {
                        console.error('저장 에러:', error);
                    });
            }

        </script>
    </body>
</html>